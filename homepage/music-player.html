<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Music Player</title>
</head>
<body>
    <audio id="bgMusic" loop preload="auto">
        <source src="wedding-music.mp3" type="audio/mpeg">
    </audio>

    <script>
        var bgMusic = document.getElementById('bgMusic');
        var hasStarted = false;
        var playAttempts = 0;

        // Get saved music state and time
        var musicState = sessionStorage.getItem('musicPlaying');
        var savedTime = parseFloat(sessionStorage.getItem('musicTime') || '0');

        console.log('Music player loaded - musicState:', musicState, 'savedTime:', savedTime);

        // Set the saved time
        if (savedTime > 0) {
            bgMusic.currentTime = savedTime;
        }

        // Function to start music
        function startMusic() {
            console.log('startMusic called - hasStarted:', hasStarted, 'playAttempts:', playAttempts);
            playAttempts++;
            
            if (musicState === 'false' && playAttempts === 1) {
                console.log('Music was paused by user, not auto-starting');
                return;
            }

            bgMusic.play().then(function() {
                hasStarted = true;
                sessionStorage.setItem('musicPlaying', 'true');
                console.log('✓ Music started successfully at time:', bgMusic.currentTime);
            }).catch(function(error) {
                console.log('✗ Play prevented:', error.message);
                if (playAttempts < 3) {
                    // Try again after a short delay
                    setTimeout(startMusic, 500);
                }
            });
        }

        // Try to play immediately
        if (musicState !== 'false') {
            setTimeout(startMusic, 100);
        }

        // Save time every second
        setInterval(function () {
            if (!bgMusic.paused) {
                sessionStorage.setItem('musicTime', bgMusic.currentTime);
                sessionStorage.setItem('musicPlaying', 'true');
            }
        }, 1000);

        // Listen for commands from parent pages
        window.addEventListener('message', function (event) {
            console.log('Message received:', event.data);
            
            if (event.data === 'startMusic') {
                console.log('Received startMusic command');
                startMusic();
            } else if (event.data === 'forcePlay') {
                // Aggressive play attempt
                bgMusic.play().then(function() {
                    console.log('Force play successful');
                    sessionStorage.setItem('musicPlaying', 'true');
                }).catch(function(e) {
                    console.log('Force play failed:', e.message);
                });
            } else if (event.data === 'toggleMusic') {
                if (bgMusic.paused) {
                    bgMusic.play().then(function() {
                        sessionStorage.setItem('musicPlaying', 'true');
                        if (event.source) {
                            event.source.postMessage({ musicPlaying: true }, '*');
                        }
                    });
                } else {
                    bgMusic.pause();
                    sessionStorage.setItem('musicPlaying', 'false');
                    if (event.source) {
                        event.source.postMessage({ musicPlaying: false }, '*');
                    }
                }
            } else if (event.data === 'getMusicState') {
                if (event.source) {
                    event.source.postMessage({
                        musicPlaying: !bgMusic.paused
                    }, '*');
                }
            }
        });

        // Save time and state before page unload
        window.addEventListener('beforeunload', function () {
            if (!bgMusic.paused) {
                sessionStorage.setItem('musicTime', bgMusic.currentTime);
                sessionStorage.setItem('musicPlaying', 'true');
            }
        });

        // Mobile-specific: Try to resume on any user interaction with the page
        var interactionEvents = ['touchstart', 'touchend', 'click'];
        var hasRespondedToInteraction = false;

        interactionEvents.forEach(function(eventType) {
            document.addEventListener(eventType, function() {
                if (!hasRespondedToInteraction && bgMusic.paused && musicState !== 'false') {
                    console.log('User interaction detected, attempting to play');
                    hasRespondedToInteraction = true;
                    startMusic();
                }
            }, { once: true, passive: true });
        });
    </script>
</body>
</html>


