<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Music Player</title>
</head>
<body>
  <audio id="bgMusic" loop preload="auto">
    <source src="homepage/wedding-music.mp3" type="audio/mpeg">
  </audio>

  <script>
    var bgMusic = document.getElementById('bgMusic');
    // persist state/time in sessionStorage
    var savedTime = parseFloat(sessionStorage.getItem('musicTime') || '0');
    if (!isNaN(savedTime) && savedTime > 0) {
      try { bgMusic.currentTime = savedTime; } catch (e) {}
    }

    function notifyState() {
      parent.postMessage({ musicPlaying: !bgMusic.paused }, '*');
    }

    // Try to play if session says it was playing
    if (sessionStorage.getItem('musicPlaying') === 'true') {
      bgMusic.muted = true;
      bgMusic.play().then(function() {
        setTimeout(function() {
          bgMusic.muted = false;
          notifyState();
        }, 150);
      }).catch(function() {
        notifyState();
      });
    } else {
      notifyState();
    }

    // Save time while playing
    setInterval(function() {
      if (!bgMusic.paused) {
        sessionStorage.setItem('musicTime', bgMusic.currentTime);
        sessionStorage.setItem('musicPlaying', 'true');
      }
    }, 1000);

    window.addEventListener('message', function (ev) {
      var data = ev.data;
      if (data === 'toggleMusic') {
        if (bgMusic.paused) {
          bgMusic.play().then(function(){ sessionStorage.setItem('musicPlaying','true'); parent.postMessage({musicPlaying:true},'*'); }).catch(function(){ parent.postMessage({musicPlaying:false},'*'); });
        } else {
          bgMusic.pause();
          sessionStorage.setItem('musicPlaying','false');
          parent.postMessage({musicPlaying:false},'*');
        }
      } else if (data === 'getMusicState') {
        parent.postMessage({ musicPlaying: !bgMusic.paused }, '*');
      } else if (data === 'startMusic') {
        bgMusic.play().then(function(){ sessionStorage.setItem('musicPlaying','true'); parent.postMessage({musicPlaying:true},'*'); }).catch(function(){ parent.postMessage({musicPlaying:false},'*'); });
      }
    }, false);

    window.addEventListener('beforeunload', function () {
      if (!bgMusic.paused) {
        sessionStorage.setItem('musicTime', bgMusic.currentTime);
        sessionStorage.setItem('musicPlaying', 'true');
      }
    });

    // allow user interaction to start music when needed
    ['touchstart','click','keydown'].forEach(evt => {
      document.addEventListener(evt, function handler() {
        if (bgMusic.paused && sessionStorage.getItem('musicPlaying') !== 'false') {
          bgMusic.play().catch(()=>{});
        }
        document.removeEventListener(evt, handler);
      }, {passive:true});
    });
  </script>
</body>
</html>
